<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Meeting Room</title>

    <style>
        body {
            margin: 0;
            font-family: Arial;
            background: #202124;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== HEADER ===== */

        .header {
            background: #1f1f1f;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .room-info {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .copy-btn {
            background: #1a73e8;
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }


        /* ===== CHAT AREA ===== */

        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            background: #2b2b2b;
            border-radius: 8px;
            width: fit-content;
        }

        /* ===== INPUT AREA ===== */

        .footer {
            display: flex;
            padding: 12px;
            background: #1f1f1f;
        }

        .footer input {
            flex: 1;
            padding: 10px;
        }

        .footer button {
            margin-left: 10px;
            padding: 10px 18px;
        }

        .message-row {
            display: flex;
            margin-bottom: 12px;
        }

        .message-row.self {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 60%;
            padding: 10px 14px;
            border-radius: 12px;
            background: #2b2b2b;
        }

        .message-row.self .message-bubble {
            background: #1a73e8;
        }

        .sender {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 4px;
            text-align: right;
        }

        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #chat {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .users-panel {
            width: 240px;
            background: #181818;
            border-left: 1px solid #333;
            padding: 15px;
            overflow-y: auto;
        }

        .user-item {
            padding: 8px 10px;
            margin-bottom: 6px;
            background: #2b2b2b;
            border-radius: 6px;
            font-size: 14px;
        }

        .leave-btn {
            background: #d93025;
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .leave-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <div class="header">
        <div class="room-info">
            Room ID:
            <b id="roomIdText"></b>
            <button class="copy-btn" onclick="copyRoomID()">Click to copy</button>
        </div>

        <button class="leave-btn" onclick="leaveRoom()">Leave</button>
    </div>


    <div class="main">
        <div class="chat-area">
            <div id="chat"></div>

            <div class="footer">
                <input id="msg" placeholder="Type message...">
                <button onclick="send()">Send</button>
            </div>
        </div>


        <div class="users-panel">
            <h3>Users in room</h3>
            <div id="users"></div>
        </div>
    </div>


    <script>

        const params = new URLSearchParams(window.location.search);
        const username = params.get("username") || "Guest";

        const roomId = params.get("room_id");

        document.getElementById("roomIdText").innerText = roomId;

        /* ===== WEBSOCKET ===== */

        let connected = false;

        function goHome() {
            window.location.href = "/";
        }

        const protocol =
            location.protocol === "https:" ? "wss" : "ws";

        const ws = new WebSocket(
            `${protocol}://${location.host}/rooms/${roomId}?username=${username}`
        );


        const connectTimeout = setTimeout(() => {
            if (!connected) {
                ws.close();
                goHome();
            }
        }, 5000);

        ws.onopen = () => {
            connected = true;
            clearTimeout(connectTimeout);
        };

        ws.onerror = () => {
            goHome();
        };

        ws.onclose = () => {
            if (!connected) {
                goHome();
            }
        };


        const chat = document.getElementById("chat");

        const usersBox = document.getElementById("users");

        // lưu user hiện tại trong room
        const users = new Map();


        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);

            // ===== CHAT =====
            if (msg.type === "chat") {
                renderChat(msg.data);
                return;
            }

            // ===== USER JOIN =====
            if (msg.type === "connect_user") {
                users.set(msg.data.id, msg.data);
                renderUsers();
                return;
            }

            // ===== USER LEAVE =====
            if (msg.type === "disconnect_user") {
                users.delete(msg.data.id);
                renderUsers();
                return;
            }
        };


        function renderChat(chatMsg) {
            const row = document.createElement("div");
            row.classList.add("message-row");

            if (chatMsg.from === username) {
                row.classList.add("self");
            }

            const bubble = document.createElement("div");
            bubble.className = "message-bubble";

            const sender = document.createElement("div");
            sender.className = "sender";
            sender.textContent = chatMsg.from;

            const content = document.createElement("div");
            content.textContent = chatMsg.content;

            const time = document.createElement("div");
            time.className = "time";

            const date = new Date(chatMsg.send_at * 1000);
            time.textContent = date.toLocaleTimeString();

            bubble.appendChild(sender);
            bubble.appendChild(content);
            bubble.appendChild(time);

            row.appendChild(bubble);
            chat.appendChild(row);

            chat.scrollTop = chat.scrollHeight;
        }

        function renderUsers() {
            usersBox.innerHTML = "";

            users.forEach((u) => {
                const div = document.createElement("div");
                div.className = "user-item";
                div.textContent = u.username;
                usersBox.appendChild(div);
            });
        }


        function send() {
            const input = document.getElementById("msg");
            if (!input.value) return;

            ws.send(input.value);
            input.value = "";
        }

        async function loadUsers() {
            const res = await fetch(`/rooms/${roomId}/users`);
            const data = await res.json();

            data.forEach(u => users.set(u.id, u));
            renderUsers();
        }

        loadUsers();

        function copyRoomID() {
            navigator.clipboard.writeText(roomId);
            alert("Room ID copied!");
        }

        function leaveRoom() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close(1000, "user leave");
            }

            if (connected) goHome()
        }

    </script>

</body>

</html>